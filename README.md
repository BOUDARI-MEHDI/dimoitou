## What's in the box

> Client-side is supported by MithrilJS which is a modern client-side JavaScript framework.

> Proxy is supported by Fastify which is a web framework, for Node.js. We use it to delivers resources to the front and makes calls to dialogflow.

> Firebase which is a Google service, we use the authentication part of Firebase.

> Weppack which is a module bundler, we use it to bundle all our JavaScript files, to compile SCSS into CSS file, to manage environments variable client-side.

> Google App Engine which is an hosting platform of the Google Cloud Platform, we use it to deploy our application.

## Configuration and usage

Update/Install Node 14

`npm install -g n`
`n 14.9.0`

Install all dependencies for client-side and proxy in the folder root

`npm install`

Run client side

`npm run front-watch`

Run proxy

`npm run server-watch`

Run both (recommended)

`npm run watch`

- You have to create a `.env` file at the root of the project, the application work with environments variable.
    - You must have a service account to be able to identify your local server as the appengine server (cf: json file that you can retrieve in the google cloud console or ask a teammates with one to share it with you using GPG, do not share it normally). 

```
GOOGLE_APPLICATION_CREDENTIALS=/path/to/service-account/qpm-dev-f9ee5fa5006d.json
BOT_NAME=qpm
PROJECT_ID=qpm-dev
DOMAIN_NAME=qpm-dev.ew.r.appspot.com
DIALOGFLOW_ENVIRONNEMENT=dev
FIREBASE_ENVIRONMENT=dev
TENANT_ID=75b53e14-xxxx-xxxx-xxxx-xxxxxxxxxxxx
FEEDBACK_TOPIC_NAME=projects/bots-shared/topics/user-feedbacks-dev
ANALYTICS_ID=UA-xxxxxxx-x
USER_INFO_ENV=r7
USER_INFO_URL_DOMAIN=europe-west1-bots-shared.cloudfunctions.net
USER_INFO_URL_PATH=user-info-fetcher-dev
```

## Building

Front-end files are generated by Webpack.

Run command : `npm run build`

## Deployment

To deploy you have two way, manually and automatically with CD (cloudbuild - Google Cloud Platform Service).

### Manually (use in last resort):

- Be sure you have a `.env` file with all environments variable which match with the environment on which you want to deploy (only for client-side variables).
- In your `app.yaml` in the project root, make sure the environments variable match with the values on which you want to deploy (only the proxy environments variable are useful in the `app.yaml`). 
- In `front-src/javascript/service/firebaseService.js`, be sure to have the correct firebase config (match with the environment), you can find the config in firebase console.
- Run `npm run build` to build the application with webpack. 
- Run `gcloud init` to setup the correct project on which you want to deploy the application.
- Run `gcloud app deploy app.yaml -v $version` with `$version` a version like `year-day-month-v-numberOfTheVersion`.

### Automatically: 

Deployment is fully automated for each git push and the name of the branch determine the environnement. See the `cloudbuild.yaml` file for more details.  
The drawback of full automation is that you can override someone else deployment when you push.   
**_Communicate_** because communication is key!

- If you add a new environment variable :
    - In the corresponding trigger (you will find in cloud build section of your project), add a subtitution variable which will be use in the `cloudbuild.yaml` file.
    - In the `cloudbuild.yaml` file, add the substitution variable in args in the replacing var in template, for exemple `-e ~s~{ANALYTICS_ID}~$_ANALYTICS_ID~`.
    - In case the environement variable is used by the client-side, add the --env option to the build running step with your variable in `cloudbuild.yaml` file, for exemple `--env.ANALYTICS_ID=$_ANALYTICS_ID`. It's because in client-side, we can't have environments variable, the browser can't access it, so we serve them as placeholders and we will replace them to real value when webpack will compile our code.
    - In case the environment variable is used by proxy, just add them to the `app.yaml` environments variable.

- If you want test cloud build from your local without push modification on git. 

`gcloud builds submit . --config cloudbuild.yaml --substitutions _DIALOGFLOW_ENVIRONNEMENT=dev,_ANALYTICS_ID=UA-xxxxxxx-x`


> [WARNING] DO NOT PUSH ON GIT A VALUE WHICH HAVE TO BE AN ENVIRONMENT VARIABLE, IT COULD BE SENSITIVE DATA.
